name: Build and Publish Docker Image

on:
  push:
    branches:
      - master
    paths:
      - 'Dockerfile.*'
      - 'misc/*'
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:


jobs:
  build-base:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.texlive
          push: true
          tags: maclotsen/texlive:latest

  build-google-fonts:
    runs-on: ubuntu-latest
    needs: build-base      # eerst base bouwen en pushen
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push fonts image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.google-fonts
          push: true
          tags: maclotsen/texlive:with-gf

  notify:
    needs: [build-base, build-google-fonts]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Compose build status
        id: compose
        run: |
          status_base="${{ needs.build-base.result }}"
          status_gf="${{ needs.build-google-fonts.result }}"

          overall="SUCCESS"
          if [ "$status_base" != "success" ] || [ "$status_gf" != "success" ]; then
            overall="FAILURE"
          fi

          cat <<EOF >> "$GITHUB_OUTPUT"
          status=$overall
          body<<MESSAGE
          Docker image build summary

          Base image (maclotsen/texlive:latest): $status_base
          Google Fonts image (maclotsen/texlive:with-gf): $status_gf

          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Run Number: ${{ github.run_number }}
          Repository: ${{ github.repository }}
          Branch/Ref: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Actor: ${{ github.actor }}
          MESSAGE
          EOF

      - name: Add job summary
        run: |
          {
            echo "## Docker Image Build Status: ${{ steps.compose.outputs.status }}";
            echo;
            echo "${{ steps.compose.outputs.body }}";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Send status email
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[XDP Docker] Build maclotsen/texlive images: ${{ steps.compose.outputs.status }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          content_type: text/plain
          body: ${{ steps.compose.outputs.body }}

